<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="prev" title="Packaging SageMath Downstream" href="downstream.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>Packaging the Sage Library for Modularized Distribution in passagemath - Developer Guide</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="_static/custom-furo.css?v=d2ecc25a" />
    <link rel="stylesheet" type="text/css" href="_static/custom-jupyter-sphinx.css?v=75860c6b" />
    <link rel="stylesheet" type="text/css" href="_static/custom-codemirror-monokai.css?v=b5588f12" />
    <link rel="stylesheet" type="text/css" href="_static/custom-tabs.css?v=8a724d73" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  --color-brand-primary: #0f0fff;
  --color-brand-content: #0f0fff;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Developer Guide</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/logo_sagemath_black.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/logo_sagemath_white.svg" alt="Dark Logo"/>
  </div>
  
      <span class="sidebar-brand-text">passagemath 10.6.1 Documentation</span>
  
</a><div class="select-wrapper">
  <select id="versions-menu" onchange="changeVersion()">
    <option value="" selected>other version</option>
    <option value="https://doc-develop--sagemath.netlify.app">develop</option>
  </select>
</div><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-home">
  <div class="sidebar-tree">
    <ul><li class="toctree-l1">
      <a class="reference internal" href="index.html">Home - Developer Guide</a>
    </li></ul>
  </div>
</div><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="walkthrough.html">Development Walk-through</a></li>
<li class="toctree-l1"><a class="reference internal" href="git_setup.html">Setting Up Git</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="github.html">The Sage Repository on GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Using Git with GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="review.html">Reviewing Code</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="git_basic.html">Git Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="git_advanced.html">Advanced Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="git_background.html">Git Tips and References</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="workspace.html">Setting up Your Workspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_basics.html">General Conventions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="doctesting.html">Running Sage’s Doctests</a></li>
<li class="toctree-l1"><a class="reference internal" href="portability_testing.html">Testing on Multiple Platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Development and Testing Tools</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="sage_manuals.html">The Sage Manuals</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="coding_in_python.html">Coding in Python for Sage</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_in_cython.html">Coding in Cython</a></li>
<li class="toctree-l1"><a class="reference internal" href="coding_in_other.html">Using External Libraries and Interfaces</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="packaging.html">Packaging Third-Party Code for Sage</a></li>
<li class="toctree-l1"><a class="reference internal" href="downstream.html">Packaging SageMath Downstream</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Packaging the Sage Library for Modularized Distribution in passagemath</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/passagemath/passagemath/blob/develop/src/doc/en/developer/packaging_sage_library.rst" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/passagemath/passagemath/edit/develop/src/doc/en/developer/packaging_sage_library.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="packaging-the-sage-library-for-modularized-distribution-in-passagemath">
<span id="chapter-modularization"></span><h1>Packaging the Sage Library for Modularized Distribution in passagemath<a class="headerlink" href="#packaging-the-sage-library-for-modularized-distribution-in-passagemath" title="Link to this heading">¶</a></h1>
<section id="modules-packages-distribution-packages">
<h2>Modules, packages, distribution packages<a class="headerlink" href="#modules-packages-distribution-packages" title="Link to this heading">¶</a></h2>
<p>The Sage library consists of a large number of Python modules,
organized into a hierarchical set of packages that fill the namespace
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage</span></code>.  All source files are located in a subdirectory of the
directory <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src/sage/">SAGE_ROOT/src/sage/</a>.</p>
<p>For example,</p>
<ul class="simple">
<li><p>the file <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src/sage/coding/code_bounds.py">SAGE_ROOT/src/sage/coding/code_bounds.py</a> provides the
module <a class="reference external" href="../reference/coding/sage/coding/code_bounds.html#module-sage.coding.code_bounds" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.coding.code_bounds</span></code></a>;</p></li>
<li><p>the directory containing this file, <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src/sage/coding/">SAGE_ROOT/src/sage/coding/</a>,
thus provides the package <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.coding</span></code>.</p></li>
</ul>
<p>There is another notion of “package” in Python, the <strong>distribution
package</strong> (also known as a “distribution” or a “pip-installable
package”).  In passagemath, the entire Sage library is provided by a
distribution <a class="reference external" href="https://pypi.org/project/passagemath-standard/">passagemath-standard</a>,
which is generated from the directory
<a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/pkgs/sagemath-standard">SAGE_ROOT/pkgs/sagemath-standard</a>.</p>
<p>Note that the distribution name is not required to be a Python
identifier. In fact, using dashes (<code class="docutils literal notranslate"><span class="pre">-</span></code>) is preferred to underscores in
distribution names; <strong>setuptools</strong> and other parts of Python’s packaging
infrastructure normalize underscores to dashes. (Using dots in
distribution names, to indicate ownership by organizations, still
mentioned in <a class="reference external" href="https://www.python.org/dev/peps/pep-0423/">PEP 423</a>, appears to
have largely fallen out of favor, and we are not using it in passagemath.</p>
<p>Any distribution that provides Python modules in the <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.*</span></code> namespace, say
mainly from <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.PAC.KAGE</span></code>, should be named <strong>passagemath-DISTRI-BUTION</strong>.
Example:</p>
<ul class="simple">
<li><p>The distribution
<a class="reference external" href="https://pypi.org/project/passagemath-categories/">passagemath-categories</a>
provides a small subset of the modules of the Sage library, mostly
from the packages <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.structure</span></code>, <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.categories</span></code>, and
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.misc</span></code>.</p></li>
</ul>
<p>A distribution that provides functionality that does not need to
import anything from the <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage</span></code> namespace should not use the
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage</span></code> namespace for its own packages/modules. It should be
positioned as part of the general Python ecosystem instead of as a
Sage-specific (or passagemath-specific) distribution.  Example:</p>
<ul class="simple">
<li><p>The distribution <a class="reference external" href="https://pypi.org/project/memory-allocator/">memory-allocator</a>
provides the Python package <code class="xref py py-mod docutils literal notranslate"><span class="pre">memory_allocator</span></code>. This used to be
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.ext.memory_allocator</span></code>, a part of the Sage library.</p></li>
</ul>
<p>However, forks of packages made for the passagemath project can also be named
<strong>passagemath-DISTRI-BUTION</strong> for branding purposes, regardless of what
namespace they fill.</p>
<ul class="simple">
<li><p>The distribution <a class="reference external" href="https://pypi.org/project/passagemath-sws2rst/">passagemath-sws2rst</a>
is a fork of <a class="reference external" href="https://pypi.org/project/sage-sws2rst/">sage-sws2rst</a>.
It provides the Python package <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage_sws2rst</span></code>, so it does not fill
the <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.*</span></code> namespace.</p></li>
<li><p>The distribution <a class="reference external" href="https://pypi.org/project/passagemath-ppl/">passagemath-ppl</a>
is a fork of <a class="reference external" href="https://pypi.org/project/pplpy/">pplpy</a>. It provides the Python
package <a class="reference external" href="/Users/mkoeppe/s/sage/sage-rebasing/local/share/doc/pplpy/index.html#module-ppl" title="(in pplpy v0.8.10.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">ppl</span></code></a> and is a much extended version of what used to be
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.libs.ppl</span></code>, a part of the Sage library. The package <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.libs.ppl</span></code> had
dependencies on <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings</span></code> to convert to/from Sage number
types. <strong>pplpy</strong> has no such dependencies and is therefore usable in a
wider range of Python projects.</p></li>
</ul>
<section id="ordinary-packages-vs-implicit-namespace-packages">
<span id="section-namespace-packages"></span><h3>Ordinary packages vs. implicit namespace packages<a class="headerlink" href="#ordinary-packages-vs-implicit-namespace-packages" title="Link to this heading">¶</a></h3>
<p>Each module of the Sage library must be packaged in exactly one distribution
package. However, modules in a package may be included in different
distribution packages. In this regard, there is an important constraint that an
ordinary package (directory with <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file) cannot be split into
more than one distribution package.</p>
<p>By removing the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file, however, we can make the package an
“implicit” (or “native”) “namespace” package, following
<a class="reference external" href="https://www.python.org/dev/peps/pep-0420/">PEP 420</a>. Implicit namespace packages can be
included in more than one distribution package. Hence whenever there are two
distribution packages that provide modules with a common prefix of Python
packages, that prefix needs to be a implicit namespace package, i.e., there
cannot be an <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file.</p>
<p>For example,</p>
<ul class="simple">
<li><p><strong>passagemath-tdlib</strong> provides <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs.graph_decompositions.tdlib</span></code>,</p></li>
<li><p><strong>passagemath-rw</strong> provides <a class="reference external" href="../reference/graphs/sage/graphs/graph_decompositions/rankwidth.html#module-sage.graphs.graph_decompositions.rankwidth" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs.graph_decompositions.rankwidth</span></code></a>,</p></li>
<li><p><strong>passagemath-graphs</strong> provides all of the rest of
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs.graph_decompositions</span></code> (and most of <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs</span></code>).</p></li>
</ul>
<p>Then, none of</p>
<ul class="simple">
<li><p><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage</span></code>,</p></li>
<li><p><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs</span></code>,</p></li>
<li><p><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs.graph_decomposition</span></code></p></li>
</ul>
<p>can be an ordinary package (with an <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file), but rather
each of them has to be an implicit namespace package (no
<code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file).</p>
<p>For an implicit namespace package, <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> cannot be used any more for
initializing the package.</p>
<p>In passagemath, most packages have been made implicit namespace packages.</p>
</section>
</section>
<section id="source-directories-of-distribution-packages">
<h2>Source directories of distribution packages<a class="headerlink" href="#source-directories-of-distribution-packages" title="Link to this heading">¶</a></h2>
<p>The development of the Sage library uses a monorepo strategy for
all distribution packages that fill the <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.*</span></code> namespace.  This
means that the source trees of these distributions are included in a
single <code class="docutils literal notranslate"><span class="pre">git</span></code> repository, in a subdirectory of <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/pkgs">SAGE_ROOT/pkgs</a>.</p>
<p>All these distribution packages have matching version numbers.  From
the viewpoint of a single distribution, this means that sometimes
there will be a new release of some distribution where the only thing
changing is the version number.</p>
<p>The source directory of a distribution package, such as
<a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/pkgs/sagemath-modules">SAGE_ROOT/pkgs/sagemath-modules</a>, contains the following files:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">sage</span></code> – a relative symbolic link to the monolithic Sage library
source tree <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src/sage/">SAGE_ROOT/src/sage/</a></p></li>
<li><p><a class="reference external" href="https://packaging.python.org/guides/using-manifest-in/">MANIFEST.in</a> –
controls which files and directories of the
monolithic Sage library source tree are included in the distribution</p>
<p>The manifest should be kept in sync with the directives of the form
<code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">sage_setup:</span> <span class="pre">distribution</span> <span class="pre">=</span> <span class="pre">sagemath-polyhedra</span></code> at the top of
source files.  Sage provides a tool <code class="docutils literal notranslate"><span class="pre">sage</span> <span class="pre">--fixdistributions</span></code>
that assists with this task. For example:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./sage --fixdistributions --set sagemath-polyhedra \</span>
<span class="go">     src/sage/geometry/polyhedron/base*.py</span>
</pre></div>
</div>
<p>adds or updates the directives in the specified files; and:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./sage --fixdistributions --add sagemath-polyhedra \</span>
<span class="go">     src/sage/geometry/polyhedron</span>
</pre></div>
</div>
<p>adds the directive to all files in the given directory that do not
include a directive yet.</p>
<p>After a distribution has been built (for example, by the command
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">pypi-wheels</span></code>) or at least an sdist has been built (for
example, by the command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">sagemath_polyhedra-sdist</span></code>), the
distribution directives in all files in the source distribution
can be updated using the switch <code class="docutils literal notranslate"><span class="pre">--from--egg-info</span></code>:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./sage --fixdistributions --set sagemath-polyhedra --from-egg-info</span>
</pre></div>
</div>
<p>To take care of all distributions, use:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./sage --fixdistributions --set all --from-egg-info</span>
</pre></div>
</div>
</li>
<li><p><a class="reference external" href="https://pip.pypa.io/en/stable/reference/build-system/pyproject-toml/">pyproject.toml</a>
and <a class="reference external" href="https://pip.pypa.io/en/stable/user_guide/#requirements-files">requirements.txt</a> –
standard Python packaging metadata, declaring the distribution name, dependencies,
etc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">README.rst</span></code> – a description of the distribution</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LICENSE.txt</span></code> – relative symbolic link to the same files
in <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src">SAGE_ROOT/src</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERSION.txt</span></code> – package version. This file is updated by the release manager by
running the <code class="docutils literal notranslate"><span class="pre">update-version</span></code> script.</p>
<p>Sometimes it may be necessary to upload a hotfix for a distribution
package to PyPI. These should be marked by adding a suffix
<code class="docutils literal notranslate"><span class="pre">.post1</span></code>, <code class="docutils literal notranslate"><span class="pre">.post2</span></code>; see <a class="reference external" href="https://peps.python.org/pep-0440/#post-releases">PEP 440 on post-releases</a>. For example, if
the current development release is <code class="docutils literal notranslate"><span class="pre">9.7.beta8</span></code>, then such a
version could be marked <code class="docutils literal notranslate"><span class="pre">9.7.beta8.post1</span></code>.</p>
<p>Also sometimes when working on PRs it may be necessary to
increment the version because a new feature is needed in another
distribution package. Such versions should be marked by using the
version number of the anticipated next development release and
adding a suffix <code class="docutils literal notranslate"><span class="pre">.dev1</span></code>, <code class="docutils literal notranslate"><span class="pre">.dev2</span></code> …  (see <a class="reference external" href="https://peps.python.org/pep-0440/#developmental-releases">PEP 440 on
developmental releases</a>).
For example, if the current development release is <code class="docutils literal notranslate"><span class="pre">9.7.beta8</span></code>,
use <code class="docutils literal notranslate"><span class="pre">9.7.beta9.dev1</span></code>. If the current development release is
the stable release <code class="docutils literal notranslate"><span class="pre">9.8</span></code>, use <code class="docutils literal notranslate"><span class="pre">9.9.beta0.dev1</span></code>.</p>
<p>After the PR is merged in the next development version, it will
be synchronized again with the other package versions.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">setup.py</span></code> – a <a class="reference external" href="https://pypi.org/project/setuptools/">setuptools</a>-based
installation script</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tox.ini</span></code> – configuration for testing with <a class="reference external" href="https://pypi.org/project/tox/">tox</a></p></li>
</ul>
<p>The technique of using symbolic links pointing into <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src">SAGE_ROOT/src</a>
has allowed the modularization effort to keep the <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/src">SAGE_ROOT/src</a>
tree monolithic: Modularization has been happening behind the scenes
and will not change where Sage developers find the source files.</p>
<p>Some of these files may actually be generated from source files with suffix <code class="docutils literal notranslate"><span class="pre">.m4</span></code> by the
<a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/bootstrap">SAGE_ROOT/bootstrap</a> script via the <code class="docutils literal notranslate"><span class="pre">m4</span></code> macro processor.</p>
<p>For every distribution package, there is also a subdirectory of <a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/build/pkgs/">SAGE_ROOT/build/pkgs/</a>,
which contains the build infrastructure that is specific to Sage-the-distribution.
Note that these subdirectories follows a different naming convention,
using underscores instead of dashes, see <a class="reference internal" href="packaging.html#section-directory-structure"><span class="std std-ref">Directory structure</span></a>.
Because the distribution packages are included in the source tree, we set them
up as “script packages” instead of “normal packages”, see <a class="reference internal" href="packaging.html#section-package-source-types"><span class="std std-ref">Package source types</span></a>.</p>
</section>
<section id="dependencies-and-distribution-packages">
<span id="section-dependencies-distributions"></span><h2>Dependencies and distribution packages<a class="headerlink" href="#dependencies-and-distribution-packages" title="Link to this heading">¶</a></h2>
<p>When preparing a portion of the Sage library as a distribution
package, dependencies matter.</p>
<section id="build-time-dependencies">
<h3>Build-time dependencies<a class="headerlink" href="#build-time-dependencies" title="Link to this heading">¶</a></h3>
<p>If the portion of the library contains any Cython modules, these
modules are compiled during the wheel-building phase of the
distribution package. If the Cython module uses <code class="docutils literal notranslate"><span class="pre">cimport</span></code> to pull in
anything from <code class="docutils literal notranslate"><span class="pre">.pxd</span></code> files, these files must be either part of the
portion shipped as the distribution being built, or the distribution
that provides these files must be installed in the build
environment. Also, any C/C++ libraries that the Cython module uses
must be accessible from the build environment.</p>
<p><em>Declaring build-time dependencies:</em> Modern Python packaging provides a
mechanism to declare build-time dependencies on other distribution
packages via the file <a class="reference external" href="https://pip.pypa.io/en/stable/reference/build-system/pyproject-toml/">pyproject.toml</a>
(<code class="docutils literal notranslate"><span class="pre">[build-system]</span> <span class="pre">requires</span></code>); this
has superseded the older <code class="docutils literal notranslate"><span class="pre">setup_requires</span></code> declaration. (There is no
mechanism to declare anything regarding the C/C++ libraries.)</p>
<p>While the namespace <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.*</span></code> is organized roughly according to
mathematical fields or categories, how we partition the implementation
modules into distribution packages has to respect the hard constraints
that are imposed by the build-time dependencies.</p>
<p>We can define some meaningful small distributions that just consist of
a single or a few Cython modules. For example, <strong>passagemath-tdlib</strong>
just packages the single Cython module that must be linked with <code class="docutils literal notranslate"><span class="pre">tdlib</span></code>,
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs.graph_decompositions.tdlib</span></code>.</p>
<p><em>Reducing build-time dependencies:</em> Sometimes it is possible to
replace build-time dependencies of a Cython module on a library by a
runtime dependency.  In other cases, it may be possible to split a
module that simultaneously depends on several libraries into smaller
modules, each of which has narrower dependencies.</p>
</section>
<section id="module-level-runtime-dependencies">
<h3>Module-level runtime dependencies<a class="headerlink" href="#module-level-runtime-dependencies" title="Link to this heading">¶</a></h3>
<p>Any <code class="docutils literal notranslate"><span class="pre">import</span></code> statements at the top level of a Python or Cython
module are executed when the module is imported. Hence, the imported
modules must be part of the distribution, or provided by another
distribution – which then must be declared as a run-time dependency.</p>
<p><em>Declaring run-time dependencies:</em> These dependencies are declared in
<code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> (generated from <code class="docutils literal notranslate"><span class="pre">pyproject.toml.m4</span></code>) as
<a class="reference external" href="https://setuptools.pypa.io/en/latest/userguide/dependency_management.html#declaring-required-dependency">[project] dependencies</a> (in the older terminology of <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> and <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>,
these dependencies were known as <code class="docutils literal notranslate"><span class="pre">install_requires</span></code>).</p>
<p><em>Reducing module-level run-time dependencies:</em></p>
<ul>
<li><p>Avoid importing from <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.PAC.KAGE.all</span></code> modules when <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.PAC.KAGE</span></code> is
a namespace package. The main purpose of the <code class="xref py py-mod docutils literal notranslate"><span class="pre">*.all</span></code> modules is for
populating the global interactive environment that is available to users at
the <code class="docutils literal notranslate"><span class="pre">sage:</span></code> prompt. In particular, no Sage library code should import from
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings.all</span></code>.</p>
<p>To audit the Sage library for such imports, use <code class="docutils literal notranslate"><span class="pre">sage</span> <span class="pre">--tox</span> <span class="pre">-e</span> <span class="pre">relint</span></code>.
In most cases, the imports can be fixed automatically using the
tool <code class="docutils literal notranslate"><span class="pre">sage</span> <span class="pre">--fiximports</span></code>.</p>
</li>
<li><p>Replace module-level imports by method-level imports.  Note that
this comes with a small runtime overhead, which can become
noticeable if the method is called in tight inner loops.</p></li>
<li><p>Sage provides the <a class="reference external" href="../reference/misc/sage/misc/lazy_import.html#sage.misc.lazy_import.lazy_import" title="(in Utilities v10.6.1)"><code class="xref py py-func docutils literal notranslate"><span class="pre">lazy_import()</span></code></a>
mechanism. Lazy imports can be
declared at the module level, but the actual importing is only done
on demand. It is a runtime error at that time if the imported module
is not present. This can be convenient compared to local imports in
methods when the same imports are needed in several methods.</p></li>
<li><p>Avoid the “modularization anti-pattern” of importing a class from
another module just to run an <code class="docutils literal notranslate"><span class="pre">isinstance(object,</span> <span class="pre">Class)</span></code> test, in
particular when the module implementing <code class="docutils literal notranslate"><span class="pre">Class</span></code> has heavy
dependencies.  For example, importing the class
<code class="xref py py-class docutils literal notranslate"><span class="pre">pAdicField</span></code> (or the
function <code class="xref py py-class docutils literal notranslate"><span class="pre">is_pAdicField</span></code>)
requires the libraries NTL and PARI.</p>
<p>Instead, provide an abstract base class (ABC) in a module that only
has light dependencies, make <code class="docutils literal notranslate"><span class="pre">Class</span></code> a subclass of <code class="docutils literal notranslate"><span class="pre">ABC</span></code>, and
use <code class="docutils literal notranslate"><span class="pre">isinstance(object,</span> <span class="pre">ABC)</span></code>. For example, <a class="reference external" href="../reference/rings/sage/rings/abc.html#module-sage.rings.abc" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings.abc</span></code></a>
provides abstract base classes for many ring (parent) classes,
including <a class="reference external" href="../reference/rings/sage/rings/abc.html#sage.rings.abc.pAdicField" title="(in General Rings, Ideals, and Morphisms v10.6.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sage.rings.abc.pAdicField</span></code></a>.  So we can replace:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">from sage.rings.padics.generic_nodes import pAdicFieldGeneric  # heavy dependencies</span>
<span class="go">isinstance(object, pAdicFieldGeneric)</span>
</pre></div>
</div>
<p>and:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">from sage.rings.padics.generic_nodes import is_pAdicField      # heavy dependencies</span>
<span class="go">is_pAdicField(object)                                          # deprecated</span>
</pre></div>
</div>
<p>by:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">import sage.rings.abc                                          # no dependencies</span>
<span class="go">isinstance(object, sage.rings.abc.pAdicField)</span>
</pre></div>
</div>
<p class="with-sage-tab with-python-tab">Note that going through the abstract base class only incurs a small
performance penalty:</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">Sage</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">sage:</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">Qp</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="gp">sage:</span> <span class="kn">from</span> <span class="nn">sage.rings.padics.generic_nodes</span> <span class="kn">import</span> <span class="n">pAdicFieldGeneric</span>
<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> isinstance(object, pAdicFieldGeneric)            # fast                           # not tested
<span class="go">68.7 ns ± 2.29 ns per loop (...)</span>

<span class="gp">sage:</span> <span class="kn">import</span> <span class="nn">sage.rings.abc</span>
<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> isinstance(object, sage.rings.abc.pAdicField)    # also fast                      # not tested
<span class="go">122 ns ± 1.9 ns per loop (...)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">Python</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="nb">object</span> <span class="o">=</span> <span class="n">Qp</span><span class="p">(</span><span class="n">Integer</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sage.rings.padics.generic_nodes</span> <span class="kn">import</span> <span class="n">pAdicFieldGeneric</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> isinstance(object, pAdicFieldGeneric)            # fast                           # not tested
<span class="go">68.7 ns ± 2.29 ns per loop (...)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">sage.rings.abc</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> isinstance(object, sage.rings.abc.pAdicField)    # also fast                      # not tested
<span class="go">122 ns ± 1.9 ns per loop (...)</span>
</pre></div>
</div>
</div>
</div>
</li>
<li><p>If it is not possible or desired to create an abstract base class for
<code class="docutils literal notranslate"><span class="pre">isinstance</span></code> testing (for example, when the class is defined in some
external package), other solutions need to be used.</p>
<p class="with-sage-tab with-python-tab">Note that Python caches successful module imports, but repeating an
unsuccessful module import incurs a cost every time:</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">Sage</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">sage:</span> <span class="kn">from</span> <span class="nn">sage.schemes.generic.scheme</span> <span class="kn">import</span> <span class="n">Scheme</span>
<span class="gp">sage:</span> <span class="n">sZZ</span> <span class="o">=</span> <span class="n">Scheme</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span>

<span class="gp">sage:</span> <span class="k">def</span> <span class="nf">is_Scheme_or_Pluffe</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">....:</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Scheme</span><span class="p">):</span>
<span class="gp">....:</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="gp">....:</span>    <span class="k">try</span><span class="p">:</span>
<span class="gp">....:</span>        <span class="kn">from</span> <span class="nn">xxxx_does_not_exist</span> <span class="kn">import</span> <span class="n">Pluffe</span>            <span class="c1"># slow on every call</span>
<span class="gp">....:</span>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="gp">....:</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="gp">....:</span>    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pluffe</span><span class="p">)</span>

<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> is_Scheme_or_Pluffe(sZZ)                         # fast                           # not tested
<span class="go">111 ns ± 1.15 ns per loop (...)</span>

<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> is_Scheme_or_Pluffe(ZZ)                          # slow                           # not tested
<span class="go">143 µs ± 2.58 µs per loop (...)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">Python</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sage.schemes.generic.scheme</span> <span class="kn">import</span> <span class="n">Scheme</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">sZZ</span> <span class="o">=</span> <span class="n">Scheme</span><span class="p">(</span><span class="n">ZZ</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="k">def</span> <span class="nf">is_Scheme_or_Pluffe</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="gp">...</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Scheme</span><span class="p">):</span>
<span class="gp">...</span>        <span class="k">return</span> <span class="kc">True</span>
<span class="gp">...</span>    <span class="k">try</span><span class="p">:</span>
<span class="gp">...</span>        <span class="kn">from</span> <span class="nn">xxxx_does_not_exist</span> <span class="kn">import</span> <span class="n">Pluffe</span>            <span class="c1"># slow on every call</span>
<span class="gp">...</span>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="gp">...</span>        <span class="k">return</span> <span class="kc">False</span>
<span class="gp">...</span>    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Pluffe</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> is_Scheme_or_Pluffe(sZZ)                         # fast                           # not tested
<span class="go">111 ns ± 1.15 ns per loop (...)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> is_Scheme_or_Pluffe(ZZ)                          # slow                           # not tested
<span class="go">143 µs ± 2.58 µs per loop (...)</span>
</pre></div>
</div>
</div>
</div>
<p class="with-sage-tab with-python-tab">The <a class="reference external" href="../reference/misc/sage/misc/lazy_import.html#sage.misc.lazy_import.lazy_import" title="(in Utilities v10.6.1)"><code class="xref py py-func docutils literal notranslate"><span class="pre">lazy_import()</span></code></a> mechanism can be used to simplify
this pattern via the <code class="xref py py-meth docutils literal notranslate"><span class="pre">__instancecheck__()</span></code>
method and has similar performance characteristics:</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">Sage</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">sage:</span> <span class="n">lazy_import</span><span class="p">(</span><span class="s1">&#39;xxxx_does_not_exist&#39;</span><span class="p">,</span> <span class="s1">&#39;Pluffe&#39;</span><span class="p">)</span>

<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> isinstance(sZZ, (Scheme, Pluffe))                # fast                           # not tested
<span class="go">95.2 ns ± 0.636 ns per loop (...)</span>

<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> isinstance(ZZ, (Scheme, Pluffe))                 # slow                           # not tested
<span class="go">158 µs ± 654 ns per loop (...)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">Python</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="n">lazy_import</span><span class="p">(</span><span class="s1">&#39;xxxx_does_not_exist&#39;</span><span class="p">,</span> <span class="s1">&#39;Pluffe&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> isinstance(sZZ, (Scheme, Pluffe))                # fast                           # not tested
<span class="go">95.2 ns ± 0.636 ns per loop (...)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> isinstance(ZZ, (Scheme, Pluffe))                 # slow                           # not tested
<span class="go">158 µs ± 654 ns per loop (...)</span>
</pre></div>
</div>
</div>
</div>
<p class="with-sage-tab with-python-tab">It is faster to do the import only once, for example when loading the module,
and to cache the failure.  We can use the following idiom, which makes
use of the fact that <code class="docutils literal notranslate"><span class="pre">isinstance</span></code> accepts arbitrarily nested lists
and tuples of types:</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">Sage</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">sage:</span> <span class="k">try</span><span class="p">:</span>
<span class="gp">....:</span>     <span class="kn">from</span> <span class="nn">xxxx_does_not_exist</span> <span class="kn">import</span> <span class="n">Pluffe</span>               <span class="c1"># runs once</span>
<span class="gp">....:</span> <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="gp">....:</span>     <span class="c1"># Set to empty tuple of types for isinstance</span>
<span class="gp">....:</span>     <span class="n">Pluffe</span> <span class="o">=</span> <span class="p">()</span>

<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> isinstance(sZZ, (Scheme, Pluffe))                # fast                           # not tested
<span class="go">95.9 ns ± 1.52 ns per loop (...)</span>

<span class="gp">sage:</span> <span class="o">%</span><span class="k">timeit</span> isinstance(ZZ, (Scheme, Pluffe))                 # fast                           # not tested
<span class="go">126 ns ± 1.9 ns per loop (...)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">Python</label><div class="tab-content docutils container">
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sage.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt;</span> <span class="k">try</span><span class="p">:</span>
<span class="gp">...</span>     <span class="kn">from</span> <span class="nn">xxxx_does_not_exist</span> <span class="kn">import</span> <span class="n">Pluffe</span>               <span class="c1"># runs once</span>
<span class="gp">...</span> <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="gp">...</span>     <span class="c1"># Set to empty tuple of types for isinstance</span>
<span class="gp">...</span>     <span class="n">Pluffe</span> <span class="o">=</span> <span class="p">()</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> isinstance(sZZ, (Scheme, Pluffe))                # fast                           # not tested
<span class="go">95.9 ns ± 1.52 ns per loop (...)</span>

<span class="gp">&gt;&gt;&gt;</span> <span class="o">%</span><span class="k">timeit</span> isinstance(ZZ, (Scheme, Pluffe))                 # fast                           # not tested
<span class="go">126 ns ± 1.9 ns per loop (...)</span>
</pre></div>
</div>
</div>
</div>
</li>
</ul>
</section>
<section id="other-runtime-dependencies">
<h3>Other runtime dependencies<a class="headerlink" href="#other-runtime-dependencies" title="Link to this heading">¶</a></h3>
<p>If <code class="docutils literal notranslate"><span class="pre">import</span></code> statements are used within a method, the imported module
is loaded the first time that the method is called. Hence the module
defining the method can still be imported even if the module needed by
the method is not present.</p>
<p>It is then a question whether a run-time dependency should be
declared. If the method needing that import provides core
functionality, then probably yes. But if it only provides what can be
considered “optional functionality”, then probably not, and in this
case it will be up to the user to install the distribution enabling
this optional functionality.</p>
<p>As an example, let us consider designing a distribution that centers
around the package <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.coding</span></code>. First, let’s see if it uses symbolics:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">(9.5.beta6) $ git grep -E &#39;sage[.](symbolic|functions|calculus)&#39; src/sage/coding</span>
<span class="go">src/sage/coding/code_bounds.py:        from sage.functions.other import ceil</span>
<span class="gp">...</span>
<span class="go">src/sage/coding/grs_code.py:from sage.symbolic.ring import SR</span>
<span class="gp">...</span>
<span class="go">src/sage/coding/guruswami_sudan/utils.py:from sage.functions.other import floor</span>
</pre></div>
</div>
<p>Apparently it does not in a very substantial way:</p>
<ul class="simple">
<li><p>The imports of the symbolic functions <code class="xref py py-func docutils literal notranslate"><span class="pre">ceil()</span></code>
and <code class="xref py py-func docutils literal notranslate"><span class="pre">floor()</span></code> can
likely be replaced by the artithmetic functions
<a class="reference external" href="../reference/rings_standard/sage/arith/misc.html#sage.arith.misc.integer_floor" title="(in Standard Commutative Rings v10.6.1)"><code class="xref py py-func docutils literal notranslate"><span class="pre">integer_floor()</span></code></a> and
<a class="reference external" href="../reference/rings_standard/sage/arith/misc.html#sage.arith.misc.integer_ceil" title="(in Standard Commutative Rings v10.6.1)"><code class="xref py py-func docutils literal notranslate"><span class="pre">integer_ceil()</span></code></a>.</p></li>
<li><p>Looking at the import of <code class="docutils literal notranslate"><span class="pre">SR</span></code> by <a class="reference external" href="../reference/coding/sage/coding/grs_code.html#module-sage.coding.grs_code" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.coding.grs_code</span></code></a>, it
seems that <code class="docutils literal notranslate"><span class="pre">SR</span></code> is used for running some symbolic sum, but the
doctests do not show symbolic results, so it is likely that this can
be replaced.</p></li>
<li><p>Note though that the above textual search for the module names is
merely a heuristic. Looking at the source of “entropy”, through
<code class="docutils literal notranslate"><span class="pre">log</span></code> from <a class="reference external" href="../reference/misc/sage/misc/functional.html#module-sage.misc.functional" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.misc.functional</span></code></a>, a runtime dependency on
symbolics comes in. In fact, for this reason, two doctests there are
already marked as <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">needs</span> <span class="pre">sage.symbolic</span></code>.</p></li>
</ul>
<p>So if packaged as <strong>passagemath-coding</strong>, now a domain expert would have
to decide whether these dependencies on symbolics are strong enough to
declare a runtime dependency (<code class="docutils literal notranslate"><span class="pre">install_requires</span></code>) on
<strong>passagemath-symbolics</strong>. This declaration would mean that any user who
installs <strong>passagemath-coding</strong> (<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">passagemath-coding</span></code>) would
pull in <strong>passagemath-symbolics</strong>, which has heavy compile-time
dependencies (ECL/Maxima/FLINT/Singular/…).</p>
<p>The alternative is to consider the use of symbolics by
<strong>passagemath-coding</strong> merely as something that provides some extra
features, which will only be working if the user also has installed
<strong>passagemath-symbolics</strong>.</p>
<p><em>Declaring optional run-time dependencies:</em> It is possible to declare
such dependencies as <a class="reference external" href="https://setuptools.pypa.io/en/latest/userguide/dependency_management.html#optional-dependencies">[project.optional-dependencies]</a> in <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code>
(generated from <code class="docutils literal notranslate"><span class="pre">pyproject.toml.m4</span></code>).
(In the older terminology of <code class="docutils literal notranslate"><span class="pre">setup.cfg</span></code> and <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>,
these optional dependencies were known as <code class="docutils literal notranslate"><span class="pre">extras_require</span></code>.)
This is a very limited mechanism
– in particular it does not affect the build phase of the
distribution in any way. It basically only provides a way to give a
nickname to a distribution that can be installed as an add-on.</p>
<p>In our example, we could declare an optional dependency so that users
could use <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">&quot;passagemath-coding[symbolics]&quot;</span></code>.</p>
</section>
<section id="doctest-only-dependencies">
<h3>Doctest-only dependencies<a class="headerlink" href="#doctest-only-dependencies" title="Link to this heading">¶</a></h3>
<p>Doctests often use examples constructed using functionality provided
by other portions of the Sage library.  This kind of integration
testing is one of the strengths of Sage; but it also creates extra
dependencies.</p>
<p>Fortunately, these dependencies are very mild, and we can deal with
them using the same mechanism that we use for making doctests
conditional on the presence of optional libraries: using <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">optional</span> <span class="pre">-</span>
<span class="pre">FEATURE</span></code> directives in the doctests.  Adding these directives will
allow developers to test the distribution separately, without
requiring all of Sage to be present.</p>
<p><em>Declaring doctest-only dependencies:</em> The
<a class="reference external" href="https://setuptools.pypa.io/en/latest/userguide/dependency_management.html#optional-dependencies">extras_require</a>
mechanism mentioned above can also be used for this.</p>
</section>
<section id="dependencies-of-the-sage-documentation">
<h3>Dependencies of the Sage documentation<a class="headerlink" href="#dependencies-of-the-sage-documentation" title="Link to this heading">¶</a></h3>
<p>The documentation will not be modularized.</p>
<p>However, some parts of the Sage reference manual may depend on functionality
provided by optional packages. These portions of the reference manual
should be conditionalized using the Sphinx directive <code class="docutils literal notranslate"><span class="pre">..</span> <span class="pre">ONLY::</span></code>,
as explained in <a class="reference internal" href="sage_manuals.html#section-documentation-conditional"><span class="std std-ref">Making portions of the reference manual conditional on optional features</span></a>.</p>
</section>
<section id="version-constraints-of-dependencies">
<h3>Version constraints of dependencies<a class="headerlink" href="#version-constraints-of-dependencies" title="Link to this heading">¶</a></h3>
<p>The version information for dependencies comes from the files
<code class="docutils literal notranslate"><span class="pre">build/pkgs/*/version_requirements.txt</span></code> and
<code class="docutils literal notranslate"><span class="pre">build/pkgs/*/package-version.txt</span></code>.  We use the
<a class="reference external" href="https://www.gnu.org/software/m4/manual/html_node/index.html">m4</a>
macro processor to insert the version information in the generated files
<code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> and <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code>.</p>
</section>
</section>
<section id="hierarchy-of-distribution-packages">
<h2>Hierarchy of distribution packages<a class="headerlink" href="#hierarchy-of-distribution-packages" title="Link to this heading">¶</a></h2>
<figure class="align-default">
<img alt="_images/packaging_sage_library-1.svg" class="plot-directive" src="_images/packaging_sage_library-1.svg" />
</figure>
<p>Solid arrows indicate declared runtime dependencies (<code class="docutils literal notranslate"><span class="pre">install_requires</span></code>).
Dashed arrows indicate declared optional runtime dependencies (<code class="docutils literal notranslate"><span class="pre">extras_require</span></code>).
Not shown in the diagram are build dependencies and optional dependencies for testing.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pypi.org/project/passagemath-conf/">passagemath-conf</a> is a configuration
module. It provides the configuration variable settings determined by the
<code class="docutils literal notranslate"><span class="pre">configure</span></code> script.</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/passagemath-environment/">passagemath-environment</a>
provides the connection to the system and software environment. It includes
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.env</span></code>, <a class="reference external" href="../reference/spkg/sage/features.html#module-sage.features" title="(in Packages and Features v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.features</span></code></a>, <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.misc.package_dir</span></code>, etc.</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/passagemath-objects/">passagemath-objects</a>
provides a small fundamental subset of the modules of the Sage library,
in particular all of <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.structure</span></code>, a small portion of <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.categories</span></code>,
and a portion of <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.misc</span></code>.</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/passagemath-categories/">passagemath-categories</a>
provides a small subset of the modules of the Sage library, building upon passagemath-objects.
It provides all of <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.categories</span></code> and a small portion of <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings</span></code>.</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/passagemath-repl/">passagemath-repl</a> provides
the IPython kernel and Sage preparser (<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.repl</span></code>),
the Sage doctester (<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.doctest</span></code>), and some related modules from <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.misc</span></code>.</p></li>
</ul>
</section>
<section id="testing-distribution-packages">
<span id="section-modularized-doctesting"></span><h2>Testing distribution packages<a class="headerlink" href="#testing-distribution-packages" title="Link to this heading">¶</a></h2>
<p>Of course, we need tools for testing modularized distributions of
portions of the Sage library.</p>
<ul class="simple">
<li><p>Distribution packages of the modularized Sage library must be testable separately!</p></li>
<li><p>But we want to keep integration testing with other portions of Sage too!</p></li>
</ul>
<section id="preparing-doctests-for-modularized-testing">
<h3>Preparing doctests for modularized testing<a class="headerlink" href="#preparing-doctests-for-modularized-testing" title="Link to this heading">¶</a></h3>
<p>Section <a class="reference internal" href="coding_basics.html#section-doctest-writing"><span class="std std-ref">Writing testable examples</span></a> explains how to write doctests
for Sage. Here we show how to prepare existing or new doctests so that
they are suitable for modularized testing.</p>
<p>Per section <a class="reference internal" href="coding_basics.html#section-further-conventions"><span class="std std-ref">Special markup to influence doctests</span></a>,
whenever an optional package is needed for a particular test, we use the
doctest tag <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">optional</span></code>. This mechanism can also be used for making a
doctest conditional on the presence of a portion of the Sage library.</p>
<p>The available tags take the form of package or module names such as
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.combinat</span></code>, <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.graphs</span></code>, <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.plot</span></code>, <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings.number_field</span></code>,
<a class="reference external" href="../reference/rings_numerical/sage/rings/real_double.html#module-sage.rings.real_double" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings.real_double</span></code></a>, and <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.symbolic</span></code>.  They are defined via
<a class="reference external" href="../reference/spkg/sage/features.html#sage.features.Feature" title="(in Packages and Features v10.6.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Feature</span></code></a> subclasses in the module <a class="reference external" href="../reference/spkg/sage/features/sagemath.html#module-sage.features.sagemath" title="(in Packages and Features v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.features.sagemath</span></code></a>, which
also provides the mapping from features to the distributions providing them
(actually, to SPKG names).  Using this mapping, Sage can issue installation
hints to the user.</p>
<p>For example, the package <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.tensor</span></code> is purely algebraic and has
no dependency on symbolics. However, there are a small number of
doctests that depend on <a class="reference external" href="../reference/calculus/sage/symbolic/ring.html#sage.symbolic.ring.SymbolicRing" title="(in Symbolic Calculus v10.6.1)"><code class="xref py py-class docutils literal notranslate"><span class="pre">sage.symbolic.ring.SymbolicRing</span></code></a> for integration
testing. Hence, these doctests are marked as depending on the feature
<code class="xref py py-class docutils literal notranslate"><span class="pre">sage.symbolic</span></code>.</p>
<p>By convention, because <code class="xref py py-class docutils literal notranslate"><span class="pre">sage.symbolic</span></code>
is present in a standard installation of Sage, we use the keyword <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">needs</span></code>
instead of <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">optional</span></code>. These two keywords have identical semantics;
the tool <a class="reference internal" href="doctesting.html#section-fixdoctests-optional-needs"><span class="std std-ref">sage –fixdoctests</span></a>
rewrites the doctest tags according to the convention.</p>
<p>When defining new features for the purpose of conditionalizing doctests, it may be a good
idea to hide implementation details from feature names. For example, all doctests that
use large finite fields have to depend on PARI. However, we have defined a feature
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.rings.finite_rings</span></code> (which implies the presence of <a class="reference external" href="../reference/libs/sage/libs/pari.html#module-sage.libs.pari" title="(in Reference Manual v10.6.1)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.libs.pari</span></code></a>).
Marking the doctests <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">needs</span> <span class="pre">sage.rings.finite_rings</span></code> expresses the
dependency in a clearer way than using <code class="docutils literal notranslate"><span class="pre">#</span> <span class="pre">needs</span> <span class="pre">sage.libs.pari</span></code>, and it
will be a smaller maintenance burden when implementation details change.</p>
</section>
<section id="testing-the-distribution-in-virtual-environments-with-tox">
<h3>Testing the distribution in virtual environments with tox<a class="headerlink" href="#testing-the-distribution-in-virtual-environments-with-tox" title="Link to this heading">¶</a></h3>
<p>Chapter <a class="reference internal" href="doctesting.html#chapter-doctesting"><span class="std std-ref">Running Sage’s Doctests</span></a> explains in detail how to run the
Sage doctester with various options.</p>
<p>To test a distribution package of the modularized Sage library,
we use a virtual environment in which we only install the
distribution to be tested (and its Python dependencies).</p>
<p>Let’s try it out first with the entire Sage library, represented by
the distribution <strong>passagemath-standard</strong>.  Note that after Sage has been
built normally, a set of wheels for most installed Python distribution
packages is available in <code class="docutils literal notranslate"><span class="pre">SAGE_VENV/var/lib/sage/wheels/</span></code>:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ls venv/var/lib/sage/wheels</span>
<span class="go">Babel-2.9.1-py2.py3-none-any.whl</span>
<span class="go">Cython-0.29.24-cp39-cp39-macosx_11_0_x86_64.whl</span>
<span class="go">Jinja2-2.11.2-py2.py3-none-any.whl</span>
<span class="gp">...</span>
<span class="go">scipy-1.7.2-cp39-cp39-macosx_11_0_x86_64.whl</span>
<span class="go">setuptools-58.2.0-py3-none-any.whl</span>
<span class="gp">...</span>
<span class="go">wheel-0.37.0-py2.py3-none-any.whl</span>
<span class="go">widgetsnbextension-3.5.1-py2.py3-none-any.whl</span>
<span class="go">zipp-3.5.0-py3-none-any.whl</span>
</pre></div>
</div>
<p>However, in a build of Sage with the default configuration
<code class="docutils literal notranslate"><span class="pre">configure</span> <span class="pre">--enable-editable</span></code>, there will be no wheels for the
distributions <code class="docutils literal notranslate"><span class="pre">sage_*</span></code> and <code class="docutils literal notranslate"><span class="pre">sagemath-*</span></code>.</p>
<p>To create these wheels, use the command <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">wheels</span></code>:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ make wheels</span>
<span class="gp">...</span>
<span class="go">$ ls venv/var/lib/sage/wheels/sage*</span>
<span class="gp">...</span>
<span class="go">passagemath_conf-10.5.45-py3-none-any.whl</span>
<span class="gp">...</span>
</pre></div>
</div>
<p>(You can also use <code class="docutils literal notranslate"><span class="pre">./configure</span> <span class="pre">--enable-wheels</span></code> to ensure that
these wheels are always available and up to date.)</p>
<p>Note in particular the wheel for <strong>passagemath-conf</strong>, which provides
configuration variable settings and the connection to the non-Python
packages installed in <code class="docutils literal notranslate"><span class="pre">SAGE_LOCAL</span></code>.</p>
<p>We can now set up a separate virtual environment, in which we install
these wheels and our distribution to be tested.  This is where
<a class="reference external" href="https://pypi.org/project/tox/">tox</a>
comes into play: It is the standard Python tool for creating
disposable virtual environments for testing.  Every distribution in
<a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/pkgs/">SAGE_ROOT/pkgs/</a> provides a configuration file <code class="docutils literal notranslate"><span class="pre">tox.ini</span></code>.</p>
<p>Following the comments in the file
<a class="extlink-sage_root reference external" href="https://github.com/sagemath/sage/tree/develop/pkgs/sagemath-standard/tox.ini">SAGE_ROOT/pkgs/sagemath-standard/tox.ini</a>, we can try the following
command:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./bootstrap &amp;&amp; ./sage -sh -c &#39;(cd pkgs/sagemath-standard &amp;&amp; SAGE_NUM_THREADS=16 tox -v -v -v -e sagepython-sagewheels-nopypi)&#39;</span>
</pre></div>
</div>
<p>This command does not make any changes to the normal installation of
Sage. The virtual environment is created in a subdirectory of
<code class="file docutils literal notranslate"><span class="pre">SAGE_ROOT/pkgs/sagemath-standard/.tox/</span></code>. After the command
finishes, we can start the separate installation of the Sage library
in its virtual environment:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ pkgs/sagemath-standard/.tox/sagepython-sagewheels-nopypi/bin/sage</span>
</pre></div>
</div>
<p>We can also run parts of the testsuite:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ pkgs/sagemath-standard/.tox/sagepython-sagewheels-nopypi/bin/sage -tp 4 src/sage/graphs/</span>
</pre></div>
</div>
<p>The whole <code class="docutils literal notranslate"><span class="pre">.tox</span></code> directory can be safely deleted at any time.</p>
<p>We can do the same with other distributions, for example the large
distribution <strong>passagemath-standard-no-symbolics</strong>
(from <a class="extlink-issue reference external" href="https://github.com/sagemath/sage/issues/35095">Issue #35095</a>), which is intended to provide
everything that is currently in the standard Sage library, i.e.,
without depending on optional packages, but without the packages
<code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.symbolic</span></code>, <code class="xref py py-mod docutils literal notranslate"><span class="pre">sage.calculus</span></code>, etc.</p>
<p>Again we can run the test with <code class="docutils literal notranslate"><span class="pre">tox</span></code> in a separate virtual environment:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./bootstrap &amp;&amp; make wheels &amp;&amp; ./sage -sh -c &#39;(cd pkgs/sagemath-standard-no-symbolics &amp;&amp; SAGE_NUM_THREADS=16 tox -v -v -v -e sagepython-sagewheels-nopypi-norequirements)&#39;</span>
</pre></div>
</div>
<p>Some small distributions, for example the ones providing the two
lowest levels, <a class="reference external" href="https://pypi.org/project/passagemath-objects/">passagemath-objects</a>
and <a class="reference external" href="https://pypi.org/project/passagemath-categories/">passagemath-categories</a>
(from <a class="extlink-issue reference external" href="https://github.com/sagemath/sage/issues/29865">Issue #29865</a>), can be installed and tested
without relying on the wheels from the Sage build:</p>
<div class="highlight-ipycon notranslate"><div class="highlight"><pre><span></span><span class="go">$ ./bootstrap &amp;&amp; ./sage -sh -c &#39;(cd pkgs/sagemath-objects &amp;&amp; SAGE_NUM_THREADS=16 tox -v -v -v -e sagepython)&#39;</span>
</pre></div>
</div>
<p>This command finds the declared build-time and run-time dependencies
on PyPI, either as source tarballs or as prebuilt wheels, and builds
and installs the distribution
<a class="reference external" href="https://pypi.org/project/passagemath-objects/">passagemath-objects</a> in a virtual
environment in a subdirectory of <code class="docutils literal notranslate"><span class="pre">pkgs/sagemath-objects/.tox</span></code>.</p>
<p>Building these small distributions serves as a valuable regression
testsuite.  However, a current issue with both of these distributions
is that they are not separately testable: The doctests for these
modules depend on a lot of other functionality from higher-level parts
of the Sage library. This is being addressed in <a class="extlink-issue reference external" href="https://github.com/sagemath/sage/issues/35095">Issue #35095</a>.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          <a class="prev-page" href="downstream.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Packaging SageMath Downstream</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2005--2025, The Sage Development Team
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Packaging the Sage Library for Modularized Distribution in passagemath</a><ul>
<li><a class="reference internal" href="#modules-packages-distribution-packages">Modules, packages, distribution packages</a><ul>
<li><a class="reference internal" href="#ordinary-packages-vs-implicit-namespace-packages">Ordinary packages vs. implicit namespace packages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#source-directories-of-distribution-packages">Source directories of distribution packages</a></li>
<li><a class="reference internal" href="#dependencies-and-distribution-packages">Dependencies and distribution packages</a><ul>
<li><a class="reference internal" href="#build-time-dependencies">Build-time dependencies</a></li>
<li><a class="reference internal" href="#module-level-runtime-dependencies">Module-level runtime dependencies</a></li>
<li><a class="reference internal" href="#other-runtime-dependencies">Other runtime dependencies</a></li>
<li><a class="reference internal" href="#doctest-only-dependencies">Doctest-only dependencies</a></li>
<li><a class="reference internal" href="#dependencies-of-the-sage-documentation">Dependencies of the Sage documentation</a></li>
<li><a class="reference internal" href="#version-constraints-of-dependencies">Version constraints of dependencies</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hierarchy-of-distribution-packages">Hierarchy of distribution packages</a></li>
<li><a class="reference internal" href="#testing-distribution-packages">Testing distribution packages</a><ul>
<li><a class="reference internal" href="#preparing-doctests-for-modularized-testing">Preparing doctests for modularized testing</a></li>
<li><a class="reference internal" href="#testing-the-distribution-in-virtual-environments-with-tox">Testing the distribution in virtual environments with tox</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=68afb76a"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=8e571dd6"></script>
    <script src="_static/tabs.js?v=3ee01567"></script>
    <script src="_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script src="_static/jupyter-sphinx-furo.js?v=24b7fe9d"></script>
    </body>
</html>